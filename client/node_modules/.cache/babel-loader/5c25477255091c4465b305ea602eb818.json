{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.oneOf = void 0;\n\nconst _ = require(\"lodash\");\n\nconst chain_1 = require(\"../chain\");\n\nconst context_builder_1 = require(\"../context-builder\"); // A dummy context item that gets added to surrogate contexts just to make them run\n\n\nconst dummyItem = {\n  async run() {}\n\n};\n\nfunction oneOf(chains, message) {\n  const middleware = async (req, _res, next) => {\n    const surrogateContext = new context_builder_1.ContextBuilder().addItem(dummyItem).build(); // Run each group of chains in parallel, and within each group, run each chain in parallel too.\n\n    const promises = chains.map(async chain => {\n      const group = Array.isArray(chain) ? chain : [chain];\n      const results = await Promise.all(group.map(chain => chain.run(req, {\n        dryRun: true\n      })));\n      const contexts = results.map(result => result.context);\n\n      const groupErrors = _.flatMap(contexts, 'errors'); // #536: The data from a chain within oneOf() can only be made available to e.g. matchedData()\n      // if its entire group is valid.\n\n\n      if (!groupErrors.length) {\n        contexts.forEach(context => {\n          surrogateContext.addFieldInstances(context.getData());\n        });\n      }\n\n      return groupErrors;\n    });\n\n    try {\n      const allErrors = await Promise.all(promises);\n      const success = allErrors.some(groupErrors => groupErrors.length === 0);\n\n      if (!success) {\n        // Only add an error to the context if no group of chains had success.\n        surrogateContext.addError(typeof message === 'function' ? message({\n          req\n        }) : message || 'Invalid value(s)', _.flatMap(allErrors));\n      } // Final context running pass to ensure contexts are added and values are modified properly\n\n\n      await new chain_1.ContextRunnerImpl(surrogateContext).run(req);\n      next();\n    } catch (e) {\n      next(e);\n    }\n  };\n\n  const run = async req => {\n    return new Promise((resolve, reject) => {\n      middleware(req, {}, e => {\n        e ? reject(e) : resolve();\n      });\n    });\n  };\n\n  return Object.assign(middleware, {\n    run\n  });\n}\n\nexports.oneOf = oneOf;","map":{"version":3,"sources":["C:/Projects/Dev Connector/node_modules/express-validator/src/middlewares/one-of.js"],"names":["Object","defineProperty","exports","value","oneOf","_","require","chain_1","context_builder_1","dummyItem","run","chains","message","middleware","req","_res","next","surrogateContext","ContextBuilder","addItem","build","promises","map","chain","group","Array","isArray","results","Promise","all","dryRun","contexts","result","context","groupErrors","flatMap","length","forEach","addFieldInstances","getData","allErrors","success","some","addError","ContextRunnerImpl","e","resolve","reject","assign"],"mappings":"AAAA;;AACAA,MAAM,CAACC,cAAP,CAAsBC,OAAtB,EAA+B,YAA/B,EAA6C;AAAEC,EAAAA,KAAK,EAAE;AAAT,CAA7C;AACAD,OAAO,CAACE,KAAR,GAAgB,KAAK,CAArB;;AACA,MAAMC,CAAC,GAAGC,OAAO,CAAC,QAAD,CAAjB;;AACA,MAAMC,OAAO,GAAGD,OAAO,CAAC,UAAD,CAAvB;;AACA,MAAME,iBAAiB,GAAGF,OAAO,CAAC,oBAAD,CAAjC,C,CACA;;;AACA,MAAMG,SAAS,GAAG;AAAE,QAAMC,GAAN,GAAY,CAAG;;AAAjB,CAAlB;;AACA,SAASN,KAAT,CAAeO,MAAf,EAAuBC,OAAvB,EAAgC;AAC5B,QAAMC,UAAU,GAAG,OAAOC,GAAP,EAAYC,IAAZ,EAAkBC,IAAlB,KAA2B;AAC1C,UAAMC,gBAAgB,GAAG,IAAIT,iBAAiB,CAACU,cAAtB,GAAuCC,OAAvC,CAA+CV,SAA/C,EAA0DW,KAA1D,EAAzB,CAD0C,CAE1C;;AACA,UAAMC,QAAQ,GAAGV,MAAM,CAACW,GAAP,CAAW,MAAOC,KAAP,IAAiB;AACzC,YAAMC,KAAK,GAAGC,KAAK,CAACC,OAAN,CAAcH,KAAd,IAAuBA,KAAvB,GAA+B,CAACA,KAAD,CAA7C;AACA,YAAMI,OAAO,GAAG,MAAMC,OAAO,CAACC,GAAR,CAAYL,KAAK,CAACF,GAAN,CAAUC,KAAK,IAAIA,KAAK,CAACb,GAAN,CAAUI,GAAV,EAAe;AAAEgB,QAAAA,MAAM,EAAE;AAAV,OAAf,CAAnB,CAAZ,CAAtB;AACA,YAAMC,QAAQ,GAAGJ,OAAO,CAACL,GAAR,CAAYU,MAAM,IAAIA,MAAM,CAACC,OAA7B,CAAjB;;AACA,YAAMC,WAAW,GAAG7B,CAAC,CAAC8B,OAAF,CAAUJ,QAAV,EAAoB,QAApB,CAApB,CAJyC,CAKzC;AACA;;;AACA,UAAI,CAACG,WAAW,CAACE,MAAjB,EAAyB;AACrBL,QAAAA,QAAQ,CAACM,OAAT,CAAiBJ,OAAO,IAAI;AACxBhB,UAAAA,gBAAgB,CAACqB,iBAAjB,CAAmCL,OAAO,CAACM,OAAR,EAAnC;AACH,SAFD;AAGH;;AACD,aAAOL,WAAP;AACH,KAbgB,CAAjB;;AAcA,QAAI;AACA,YAAMM,SAAS,GAAG,MAAMZ,OAAO,CAACC,GAAR,CAAYR,QAAZ,CAAxB;AACA,YAAMoB,OAAO,GAAGD,SAAS,CAACE,IAAV,CAAeR,WAAW,IAAIA,WAAW,CAACE,MAAZ,KAAuB,CAArD,CAAhB;;AACA,UAAI,CAACK,OAAL,EAAc;AACV;AACAxB,QAAAA,gBAAgB,CAAC0B,QAAjB,CAA0B,OAAO/B,OAAP,KAAmB,UAAnB,GAAgCA,OAAO,CAAC;AAAEE,UAAAA;AAAF,SAAD,CAAvC,GAAmDF,OAAO,IAAI,kBAAxF,EAA4GP,CAAC,CAAC8B,OAAF,CAAUK,SAAV,CAA5G;AACH,OAND,CAOA;;;AACA,YAAM,IAAIjC,OAAO,CAACqC,iBAAZ,CAA8B3B,gBAA9B,EAAgDP,GAAhD,CAAoDI,GAApD,CAAN;AACAE,MAAAA,IAAI;AACP,KAVD,CAWA,OAAO6B,CAAP,EAAU;AACN7B,MAAAA,IAAI,CAAC6B,CAAD,CAAJ;AACH;AACJ,GA/BD;;AAgCA,QAAMnC,GAAG,GAAG,MAAOI,GAAP,IAAe;AACvB,WAAO,IAAIc,OAAJ,CAAY,CAACkB,OAAD,EAAUC,MAAV,KAAqB;AACpClC,MAAAA,UAAU,CAACC,GAAD,EAAM,EAAN,EAAW+B,CAAD,IAAO;AACvBA,QAAAA,CAAC,GAAGE,MAAM,CAACF,CAAD,CAAT,GAAeC,OAAO,EAAvB;AACH,OAFS,CAAV;AAGH,KAJM,CAAP;AAKH,GAND;;AAOA,SAAO9C,MAAM,CAACgD,MAAP,CAAcnC,UAAd,EAA0B;AAAEH,IAAAA;AAAF,GAA1B,CAAP;AACH;;AACDR,OAAO,CAACE,KAAR,GAAgBA,KAAhB","sourcesContent":["\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.oneOf = void 0;\nconst _ = require(\"lodash\");\nconst chain_1 = require(\"../chain\");\nconst context_builder_1 = require(\"../context-builder\");\n// A dummy context item that gets added to surrogate contexts just to make them run\nconst dummyItem = { async run() { } };\nfunction oneOf(chains, message) {\n    const middleware = async (req, _res, next) => {\n        const surrogateContext = new context_builder_1.ContextBuilder().addItem(dummyItem).build();\n        // Run each group of chains in parallel, and within each group, run each chain in parallel too.\n        const promises = chains.map(async (chain) => {\n            const group = Array.isArray(chain) ? chain : [chain];\n            const results = await Promise.all(group.map(chain => chain.run(req, { dryRun: true })));\n            const contexts = results.map(result => result.context);\n            const groupErrors = _.flatMap(contexts, 'errors');\n            // #536: The data from a chain within oneOf() can only be made available to e.g. matchedData()\n            // if its entire group is valid.\n            if (!groupErrors.length) {\n                contexts.forEach(context => {\n                    surrogateContext.addFieldInstances(context.getData());\n                });\n            }\n            return groupErrors;\n        });\n        try {\n            const allErrors = await Promise.all(promises);\n            const success = allErrors.some(groupErrors => groupErrors.length === 0);\n            if (!success) {\n                // Only add an error to the context if no group of chains had success.\n                surrogateContext.addError(typeof message === 'function' ? message({ req }) : message || 'Invalid value(s)', _.flatMap(allErrors));\n            }\n            // Final context running pass to ensure contexts are added and values are modified properly\n            await new chain_1.ContextRunnerImpl(surrogateContext).run(req);\n            next();\n        }\n        catch (e) {\n            next(e);\n        }\n    };\n    const run = async (req) => {\n        return new Promise((resolve, reject) => {\n            middleware(req, {}, (e) => {\n                e ? reject(e) : resolve();\n            });\n        });\n    };\n    return Object.assign(middleware, { run });\n}\nexports.oneOf = oneOf;\n"]},"metadata":{},"sourceType":"script"}